---
- name: CA Secret | Check if ca-cert secret exists in kube-system
  shell: |
    kubectl get secret {{ ca_secret_name }} -n {{ ca_secret_namespace }} --ignore-not-found=true --no-headers=true | wc -l
  environment:
    PATH: "{{ bin_dir }}"
  register: ca_secret_exists
  run_once: true

- name: CA Secret | Create temporary directory for certificates
  file:
    path: "{{ ca_secret_tmp_dir }}"
    state: directory
    mode: '0700'
  run_once: true
  when: ca_secret_exists.stdout | int == 0

- name: CA Secret | Generate CA private key
  shell: |
    openssl genrsa -out {{ ca_secret_tmp_dir }}/ca.key 2048
  run_once: true
  when: ca_secret_exists.stdout | int == 0

- name: CA Secret | Generate CA certificate (100 years)
  shell: |
    openssl req -x509 -new -nodes -key {{ ca_secret_tmp_dir }}/ca.key \
      -days {{ cert_validity_days }} \
      -out {{ ca_secret_tmp_dir }}/ca.crt \
      -subj "{{ ca_cert_subject }}"
  run_once: true
  when: ca_secret_exists.stdout | int == 0

- name: CA Secret | Create ca-cert secret in kube-system namespace
  shell: |
    kubectl create secret generic {{ ca_secret_name }} \
      --from-file=ca.crt={{ ca_secret_tmp_dir }}/ca.crt \
      --from-file=ca.key={{ ca_secret_tmp_dir }}/ca.key \
      -n {{ ca_secret_namespace }}
  environment:
    PATH: "{{ bin_dir }}"
  run_once: true
  when: ca_secret_exists.stdout | int == 0

- name: CA Secret | Get CA certificate and key from existing secret
  shell: |
    kubectl get secret {{ ca_secret_name }} -n {{ ca_secret_namespace }} -o jsonpath='{.data.ca\.crt}' | base64 -d > {{ ca_secret_tmp_dir }}/ca.crt
    kubectl get secret {{ ca_secret_name }} -n {{ ca_secret_namespace }} -o jsonpath='{.data.ca\.key}' | base64 -d > {{ ca_secret_tmp_dir }}/ca.key
  environment:
    PATH: "{{ bin_dir }}"
  run_once: true
  when: ca_secret_exists.stdout | int > 0

- name: CA Secret | Ensure temporary directory exists for client cert
  file:
    path: "{{ ca_secret_tmp_dir }}"
    state: directory
    mode: '0700'
  run_once: true
  when: ca_secret_exists.stdout | int > 0

- name: CA Secret | Ensure namespace exists
  shell: |
    kubectl get namespace {{ client_secret_namespace }} --ignore-not-found=true --no-headers=true | wc -l
  environment:
    PATH: "{{ bin_dir }}"
  register: ns_exists
  run_once: true

- name: CA Secret | Create namespace if not exists
  shell: |
    kubectl create namespace {{ client_secret_namespace }}
  environment:
    PATH: "{{ bin_dir }}"
  run_once: true
  when: ns_exists.stdout | int == 0

- name: CA Secret | Check if client-crt secret exists in namespace
  shell: |
    kubectl get secret {{ client_secret_name }} -n {{ client_secret_namespace }} --ignore-not-found=true --no-headers=true | wc -l
  environment:
    PATH: "{{ bin_dir }}"
  register: client_secret_exists
  run_once: true

- name: CA Secret | Generate client private key
  shell: |
    openssl genrsa -out {{ ca_secret_tmp_dir }}/client.key 2048
  run_once: true
  when: client_secret_exists.stdout | int == 0

- name: CA Secret | Create OpenSSL config for client certificate
  template:
    src: openssl-client.conf.j2
    dest: "{{ ca_secret_tmp_dir }}/openssl-client.conf"
  run_once: true
  when: client_secret_exists.stdout | int == 0

- name: CA Secret | Generate client CSR
  shell: |
    openssl req -new -key {{ ca_secret_tmp_dir }}/client.key \
      -out {{ ca_secret_tmp_dir }}/client.csr \
      -subj "{{ client_cert_subject }}" \
      -config {{ ca_secret_tmp_dir }}/openssl-client.conf
  run_once: true
  when: client_secret_exists.stdout | int == 0

- name: CA Secret | Sign client certificate with CA (100 years)
  shell: |
    openssl x509 -req -in {{ ca_secret_tmp_dir }}/client.csr \
      -CA {{ ca_secret_tmp_dir }}/ca.crt \
      -CAkey {{ ca_secret_tmp_dir }}/ca.key \
      -CAcreateserial \
      -out {{ ca_secret_tmp_dir }}/client.crt \
      -days {{ cert_validity_days }} \
      -extensions v3_req \
      -extfile {{ ca_secret_tmp_dir }}/openssl-client.conf
  run_once: true
  when: client_secret_exists.stdout | int == 0

- name: CA Secret | Create client-crt secret in default namespace
  shell: |
    kubectl create secret generic {{ client_secret_name }} \
      --from-file=tls.crt={{ ca_secret_tmp_dir }}/client.crt \
      --from-file=tls.key={{ ca_secret_tmp_dir }}/client.key \
      --from-file=ca.crt={{ ca_secret_tmp_dir }}/ca.crt \
      -n {{ client_secret_namespace }}
  environment:
    PATH: "{{ bin_dir }}"
  run_once: true
  when: client_secret_exists.stdout | int == 0

- name: CA Secret | Cleanup temporary directory
  file:
    path: "{{ ca_secret_tmp_dir }}"
    state: absent
  run_once: true
